<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>米国債務リスクチャート（期間指定可能）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label, input, button { font-size: 16px; margin-right: 10px; }
    #chart-container { width: 100%; max-width: 900px; margin-top: 30px; }
  </style>
</head>
<body>
  <h2>米国債務リスクチャート</h2>

  <label for="yearsInput">表示期間（年）:</label>
  <input type="number" id="yearsInput" value="10" min="1" max="50" step="1" />
  <button id="updateBtn">チャート更新</button>

  <div id="chart-container">
    <canvas id="riskChart"></canvas>
  </div>

  <script>
    // APIキーとエンドポイントの設定（FREDの例）
    const API_KEY = 'YOUR_FRED_API_KEY_HERE';
    // 例：米国連邦政府総債務（データID: FYGFDPUN）
    const SERIES1_ID = 'FYGFDPUN';
    // 例：実質短期利回り（データID: DGS10）
    const SERIES2_ID = 'DGS10';

    let rawDates = [];  // 全期間の日付配列
    let rawSeries1 = []; // 全期間データ1（債務）
    let rawSeries2 = []; // 全期間データ2（実質利回り）
    let chart;  // Chart.jsインスタンス

    // FREDからデータ取得用関数（async/await）
    async function fetchFredSeries(seriesId) {
      const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${seriesId}&api_key=${API_KEY}&file_type=json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to fetch ${seriesId}`);
      const json = await res.json();
      return json.observations.map(o => ({
        date: o.date,
        value: o.value === '.' ? null : parseFloat(o.value)
      })).filter(o => o.value !== null);
    }

    // 全データを取得してグローバル変数にセット
    async function loadData() {
      try {
        const [data1, data2] = await Promise.all([
          fetchFredSeries(SERIES1_ID),
          fetchFredSeries(SERIES2_ID)
        ]);

        // 日付の共通部分だけ残すために共通日付を抽出
        const dates1 = data1.map(d => d.date);
        const dates2 = data2.map(d => d.date);
        const commonDates = dates1.filter(d => dates2.includes(d)).sort();

        rawDates = commonDates;
        rawSeries1 = commonDates.map(d => data1.find(x => x.date === d).value);
        rawSeries2 = commonDates.map(d => data2.find(x => x.date === d).value);

      } catch (e) {
        alert('データ取得に失敗しました: ' + e.message);
      }
    }

    // 指定した年数分のデータに絞り込んでチャートを更新
    function updateChart(years) {
      if (!rawDates.length) return;

      const cutoff = new Date();
      cutoff.setFullYear(cutoff.getFullYear() - years);

      // cutoff以降のデータだけ抽出
      const filteredIndices = rawDates.reduce((acc, d, i) => {
        if (new Date(d) >= cutoff) acc.push(i);
        return acc;
      }, []);

      const filteredDates = filteredIndices.map(i => rawDates[i]);
      const filteredSeries1 = filteredIndices.map(i => rawSeries1[i]);
      const filteredSeries2 = filteredIndices.map(i => rawSeries2[i]);

      // Chart.jsの更新
      chart.data.labels = filteredDates;
      chart.data.datasets[0].data = filteredSeries1;
      chart.data.datasets[1].data = filteredSeries2;
      chart.update();
    }

    // Chart.js初期化
    function initChart() {
      const ctx = document.getElementById('riskChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [], // 初期は空
          datasets: [
            {
              label: '米国連邦政府総債務',
              data: [],
              borderColor: 'purple',
              backgroundColor: 'transparent',
              yAxisID: 'y1',
              tension: 0.2
            },
            {
              label: '実質利回り（%）',
              data: [],
              borderColor: 'black',
              backgroundColor: 'transparent',
              yAxisID: 'y2',
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          scales: {
            y1: {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: '債務額（単位）'
              }
            },
            y2: {
              type: 'linear',
              position: 'right',
              title: {
                display: true,
                text: '実質利回り（%）'
              },
              grid: {
                drawOnChartArea: false,
              }
            },
            x: {
              title: {
                display: true,
                text: '日付'
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                maxTicksLimit: 15,
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          }
        }
      });
    }

    // 初期処理
    async function main() {
      initChart();
      await loadData();
      updateChart(parseInt(document.getElementById('yearsInput').value));
    }

    document.getElementById('updateBtn').addEventListener('click', () => {
      const years = parseInt(document.getElementById('yearsInput').value);
      if (isNaN(years) || years < 1 || years > 50) {
        alert('1〜50の年数を入力してください');
        return;
      }
      updateChart(years);
    });

    main();
  </script>
</body>
</html>
